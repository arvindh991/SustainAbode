{% extends "base.html" %}

{% load static %} <!-- Load the static tag library -->

{% block title %}Home - SustainABode{% endblock %}

{% block content %}

<div class="container-fluid">
  <div class="row">
    <!-- Render the form -->
    <form method="POST">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">Submit</button>
    </form>
    <!-- Second column for map -->
    <div class="container-fluid col-md-7">
      <div id="map" style="width: 800px; height: 600px;"></div>
    </div>
  </div>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoicmFydjAwMDEiLCJhIjoiY20wamc3NGw4MHgzZDJqb2pkd3Judzd6MyJ9.V-psI2cWdQmog7DogdbMwA';

  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v11', // style URL
    center: [144.9631, -37.8136], // starting position [lng, lat]
    zoom: 11 // starting zoom
  });

  map.on('load', function () {

    // Only load the GeoJSON if it's provided
    {% if geojson_url %}

    // Add the GeoJSON data as a source
    map.addSource('melbourne', {
      'type': 'geojson',
      'data': "{% static geojson_url %}" // Local server URL
    });

    // After the GeoJSON is loaded, get the bounds of the features and adjust the map's view
    map.on('sourcedata', function(e) {
      if (e.isSourceLoaded && e.sourceId === 'melbourne') {
          // Get the bounds of the loaded GeoJSON features
          var bounds = new mapboxgl.LngLatBounds();

          // Loop through each feature in the GeoJSON source
          var features = map.querySourceFeatures('melbourne');
          features.forEach(function(feature) {
              // Extend the bounds to include the coordinates of each feature
              var coordinates = feature.geometry.coordinates;
              coordinates.forEach(function(coord) {
                  bounds.extend(coord);
              });
          });

          // Fit the map's bounds to the GeoJSON layer
          map.fitBounds(bounds, {
              padding: 20, // Padding around the edges of the map
              maxZoom: 14, // Set a maximum zoom level
              duration: 1000 // Animation duration in milliseconds
          });
      }
  });

    // Add a new layer to visualize the polygons with colors based on suscore
    map.addLayer({
      'id': 'melbourne-layer',
      'type': 'fill',
      'source': 'melbourne',
      'paint': {
        'fill-color': [
          'interpolate',
          ['linear'],
          ['to-number', ['get', 'suscore']], // Convert suscore to a number
          1, '#FFEDA0',  // light yellow
          2, '#FED976',  // yellow
          3, '#FEB24C',  // orange
          4, '#FD8D3C',  // red-orange
          5, '#E31A1C'   // dark red
        ],
        'fill-opacity': 0.7
      }
    });

    // Add a black border around each neighborhood
    map.addLayer({
      'id': 'border-layer',
      'type': 'line',
      'source': 'melbourne',
      'paint': {
        'line-color': '#000',
        'line-width': 1
      }
    });

      // Add a new symbol layer to display the LOC_NAME (suburb name) as labels
      map.addLayer({
        'id': 'suburb-labels',
        'type': 'symbol',
        'source': 'melbourne',
        'layout': {
          'text-field': ['get', 'LOC_NAME'], // Get the suburb name from the GeoJSON
          'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
          'text-size': 12,
          'text-anchor': 'center'
        },
        'paint': {
          'text-color': '#000', // Black color for the text
          'text-halo-color': '#FFF', // White halo around the text for better readability
          'text-halo-width': 2
        }
      });
  

    let currentPopup = null;  // Keep track of the current popup

map.on('mouseenter', 'melbourne-layer', function (e) {
    // Change the cursor to a pointer to indicate hover
    map.getCanvas().style.cursor = 'pointer';

    // Get the coordinates and properties of the hovered feature (suburb)
    var coordinates = e.lngLat;
    var suburbName = e.features[0].properties.LOC_NAME;
    var houseCount = e.features[0].properties.HouseCount;
    var averagePrice = e.features[0].properties.AveragePrice;
    var averageDistance = e.features[0].properties.AverageDistance;
    var rank = e.features[0].properties.TotalRank;

    // Remove any existing popup
    if (currentPopup) {
        currentPopup.remove();
    }

  
    // Create a new popup with the suburb information
    currentPopup = new mapboxgl.Popup({
            closeButton: false, // Disable the default close button for better control
            closeOnClick: false // Prevent popup from closing on click
        })
        .setLngLat(coordinates)
        .setHTML('<h4>' + suburbName + '</h4>' +
                 '<p>House Count: ' + houseCount + '</p>' +
                 '<p>Average Price: $' + averagePrice.toFixed(2) + '</p>' +
                 '<p>Average Distance: ' + averageDistance + ' km</p>' +
                 '<p>Total Rank: ' + rank + '</p>')
        .addTo(map);
});

map.on('mouseleave', 'melbourne-layer', function () {
    // Reset cursor back to default
    map.getCanvas().style.cursor = '';

    // Remove the current popup when the mouse leaves the feature
    if (currentPopup) {
        currentPopup.remove();
        currentPopup = null;  // Ensure it's cleared out
    }
});



    {% endif %}
  });
</script>

{% endblock %}